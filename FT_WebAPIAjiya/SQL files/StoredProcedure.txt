﻿USE [FT_WebAPIAjiya]
GO
/****** Object:  StoredProcedure [dbo].[sp_execaction]    Script Date: 14/9/2023 11:00:41 AM ****/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[sp_execaction] 
	@type nvarchar(50),
	@json nvarchar(max)
AS
BEGIN
	IF @type = 'Quotation'
	BEGIN
		
		--create temp table
		CREATE TABLE #tempjson (
			QuotationNo nvarchar(50),
			CardCode nvarchar(50) 
		)

		--use OPENJSON to pull values from the JSON file and store it inside the temp table

		INSERT INTO #tempjson (QuotationNo, CardCode)
		SELECT QuotationNo, CardCode
		FROM OPENJSON(@json)
		WITH (
			QuotationNo nvarchar(50),
			CardCode nvarchar(50)
		)

		-- check for any duplicate in quotation number
		 IF EXISTS (SELECT 1 FROM quotationtable WHERE QuotationNo = (SELECT QuotationNo FROM #tempjson))
        BEGIN
            -- if quotation already exist, raise error		
            RAISERROR('QuotationNo already exists.', 16, 1);

        END

		--insert data from #tempjson into quotationtable
		INSERT INTO quotationtable (QuotationNo, CardCode)
		SELECT QuotationNo, CardCode FROM #tempjson

		DROP TABLE #tempjson

	END

END
